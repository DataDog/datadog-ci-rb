module Datadog
  module CI
    module Contrib
      module RSpec
        module Example
          def self.included: (untyped base) -> untyped
          module InstanceMethods : ::RSpec::Core::Example
            @skip_reporting: bool

            @datadog_test_suite_description: String

            @datadog_test_id: String
            @datadog_test_name: String
            @datadog_test_suite_name: String
            @datadog_test_parameters: String
            @datadog_fqn_test_id: String
            @datadog_context_ids: Array[String]
            @datadog_top_level_example_group: Hash[Symbol, untyped]

            @datadog_source_file: String?
            @datadog_source_start: Integer?
            @datadog_source_location_from_parent: bool
            @bundle_location: String?

            def run: (untyped example_group_instance, untyped reporter) -> untyped

            def datadog_test_id: () -> String
            def datadog_fqn_test_id: () -> String
            def datadog_test_name: () -> String
            def datadog_test_suite_name: () -> String
            def datadog_test_parameters: () -> String
            def datadog_test_suite_source_file_path: () -> String
            def datadog_unskippable?: () -> bool
            def datadog_context_ids: () -> Array[String]
            def datadog_source_file: () -> String?
            def datadog_source_start: () -> Integer?
            def datadog_source_location_from_parent?: () -> bool

            private

            # Run method helpers
            def build_test_tags: () -> Hash[String, String]
            def prepare_test_span: (Datadog::CI::Test? test_span) -> void
            def handle_test_result: (Datadog::CI::Test? test_span, Exception? test_failure) -> Exception?
            def update_formatter_metadata: (Datadog::CI::Test? test_span) -> void
            def update_retry_metadata: (Datadog::CI::Test? test_span) -> void
            def restore_failure_state: (Datadog::CI::Test? test_span, Exception? test_failure) -> void

            # Source location resolution
            def resolve_source_location: () -> void
            def set_source_location: (String? relative_path, Integer? line_number, from_parent: bool) -> void
            def valid_source_file_path?: (String? relative_path, String? original_path) -> bool
            def bundle_location: () -> String?

            # Hierarchy traversal
            def datadog_top_level_example_group: () -> Hash[Symbol, untyped]
            def traverse_example_group_hierarchy: () -> void
            def datadog_test_suite_description: () -> String

            # Component accessors
            def datadog_integration: () -> Datadog::CI::Contrib::Integration
            def datadog_configuration: () -> untyped
            def test_tracing_component: () -> Datadog::CI::TestTracing::Component
            def test_retries_component: () -> Datadog::CI::TestRetries::Component
            def ci_queue?: () -> bool
          end
        end
      end
    end
  end
end
